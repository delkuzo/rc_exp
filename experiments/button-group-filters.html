<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Эксперимент: Группа кнопок / фильтры - RC Experiment</title>
    <link rel="stylesheet" href="../fonts/fonts.css">
    <link rel="stylesheet" href="../styles.css">
    <script src="../icons/icon-system-v3.js"></script>
    <style>
        .experiment-page {
            max-width: 1200px;
            margin: 0;
            margin-left: 80px;
            padding: 40px 20px;
        }
        .experiment-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 40px;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--color-bg-secondary);
            color: var(--color-text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
            border: 1px solid var(--color-border-secondary);
        }
        .back-link:hover {
            background-color: var(--color-hover);
            color: var(--color-text-primary);
            border-color: var(--color-border-primary);
        }
        .back-link svg { width: 16px; height: 16px; }
        .experiment-title {
            font-family: var(--typography-display-2-font-family);
            font-weight: var(--typography-display-2-font-weight);
            font-size: var(--typography-display-2-font-size);
            line-height: var(--typography-display-2-line-height);
            color: var(--color-text-primary);
            margin: 0;
        }

        /* Локальные стили эксперимента */
        .filters-section { max-width: 100%; }
        .filters-title {
            font-family: var(--typography-header-1-font-family);
            font-weight: var(--typography-header-1-font-weight);
            font-size: var(--typography-header-1-font-size);
            line-height: var(--typography-header-1-line-height);
            color: var(--color-text-primary);
            margin: 0 0 var(--size-m) 0; /* 16px между заголовком и рядом контроллов */
        }
        .filters-row {
            display: flex;
            align-items: center;
            gap: var(--size-s-spec); /* 12px по UI‑киту */
            flex-wrap: nowrap;
        }
        .filters-row .select-container { min-width: 190px; }

        /* Локальная настройка вида опций месяца: месяц слева, год справа вторичным цветом */
        .select-dropdown .select-option {
            justify-content: space-between;
        }
        .select-option-month {
            color: var(--color-text-primary);
            font-family: 'YS Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            font-weight: 400;
            line-height: 1.4;
        }
        .select-option-year {
            color: var(--color-text-secondary);
            margin-left: auto;
            font-family: 'YS Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            font-weight: 400;
            line-height: 1.4;
        }
        .select-divider {
            height: 1px;
            background-color: var(--color-border-primary);
            margin: var(--size-xxs) var(--size-s-spec);
            border-radius: 1px;
        }

        /* Встроенный календарь в dropdown (берем стили из эксперимента "Календарь") */
        .calendar-container { display: flex; flex-direction: column; gap: var(--size-m); width: max-content; padding: var(--size-m); }
        .calendar-header { display: flex; align-items: center; gap: var(--size-s); }
        .calendar-titles { display: inline-flex; align-items: center; gap: var(--size-m); justify-content: space-between; width: calc(7 * 32px + 6 * var(--size-s)); }
        .calendar-title-group { position: relative; }
        .calendar-title-button { display: inline-flex; align-items: center; gap: var(--size-xs); padding: 4px 8px; border-radius: 6px; background: transparent; border: none; color: var(--color-red); cursor: pointer; font-family: var(--typography-header-1-font-family); font-weight: var(--typography-header-1-font-weight); font-size: var(--typography-header-1-font-size); line-height: var(--typography-header-1-line-height); }
        .calendar-title-button:hover { color: var(--color-text-primary); }
        .calendar-title-icon { width: 16px; height: 16px; display: inline-flex; }
        .calendar-title-text--month { display: inline; text-align: left; }
        .calendar-title-text--year { display: inline-block; width: 72px; text-align: right; }
        .calendar-dropdown { max-height: 180px; overflow-y: auto; margin-top: 4px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: var(--size-s); }
        .calendar-weekday { text-align: center; color: var(--color-text-secondary); font-family: var(--typography-caption-2-font-family); font-weight: var(--typography-caption-2-font-weight); font-size: var(--typography-caption-2-font-size); line-height: var(--typography-caption-2-line-height); }
        .calendar-day-btn.btn { width: 32px; height: 32px; padding: 0; border-radius: 50%; justify-content: center; align-items: center; }
        .calendar-day-btn.btn.btn--style-blank { background: transparent; }
        .calendar-day-btn.btn.btn--style-blank:hover { background: var(--color-control); }
        .calendar-day-btn.is-other-month { opacity: 0.5; }

        /* Адаптивность: на мобильных переносим в столбик */
        @media (max-width: 768px) {
            .experiment-page { margin-left: 20px; padding: 20px 16px; }
            .filters-row {
                flex-direction: column;
                align-items: stretch;
                gap: var(--size-m);
            }
        }
    </style>
</head>
<body>
    <div class="experiment-page">
        <div class="experiment-header">
            <a href="../index.html#experiments" class="btn btn--size-32 btn--style-fill btn--icon-only" aria-label="Назад">
                <span class="btn__icon" id="backIcon-filters"></span>
            </a>
            <h1 class="experiment-title">Группа кнопок / фильтры</h1>
        </div>

        <div class="experiment-result">
            <section class="filters-section" aria-labelledby="filtersTitle">
                <h4 id="filtersTitle" class="filters-title">Сформируйте отчет</h4>

                <div class="filters-row" role="group" aria-label="Панель фильтров">
                    <!-- Select: Регион -->
                    <div class="select-container" data-select="region">
                        <button type="button" class="select-button select-button--size-40" id="selectButton-region" aria-haspopup="listbox" aria-expanded="false" aria-controls="selectDropdown-region">
                            <span class="select-text">Регион</span>
                            <span class="select-icon" id="selectIcon-region">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </span>
                        </button>
                        <div class="select-dropdown" id="selectDropdown-region" role="listbox" aria-hidden="true">
                            <div class="select-option" role="option" tabindex="0" data-value="moscow"><span class="select-option-text">Москва</span></div>
                            <div class="select-option" role="option" tabindex="0" data-value="spb"><span class="select-option-text">Санкт-Петербург</span></div>
                            <div class="select-option" role="option" tabindex="0" data-value="novosibirsk"><span class="select-option-text">Новосибирск</span></div>
                            <div class="select-option" role="option" tabindex="0" data-value="ekb"><span class="select-option-text">Екатеринбург</span></div>
                            <div class="select-option" role="option" tabindex="0" data-value="kazan"><span class="select-option-text">Казань</span></div>
                        </div>
                    </div>

                    <!-- Select: Платформа -->
                    <div class="select-container" data-select="platform">
                        <button type="button" class="select-button select-button--size-40" id="selectButton-platform" aria-haspopup="listbox" aria-expanded="false" aria-controls="selectDropdown-platform">
                            <span class="select-text">Платформа</span>
                            <span class="select-icon" id="selectIcon-platform">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </span>
                        </button>
                        <div class="select-dropdown" id="selectDropdown-platform" role="listbox" aria-hidden="true">
                            <div class="select-option" role="option" tabindex="0" data-value="desktop"><span class="select-option-text">Десктоп</span></div>
                            <div class="select-option" role="option" tabindex="0" data-value="app"><span class="select-option-text">Приложение</span></div>
                            <div class="select-option" role="option" tabindex="0" data-value="mweb"><span class="select-option-text">Мобильный веб</span></div>
                        </div>
                    </div>

                    <!-- Select: Тип данных -->
                    <div class="select-container" data-select="datatype">
                        <button type="button" class="select-button select-button--size-40" id="selectButton-datatype" aria-haspopup="listbox" aria-expanded="false" aria-controls="selectDropdown-datatype">
                            <span class="select-text">Тип данных</span>
                            <span class="select-icon" id="selectIcon-datatype">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </span>
                        </button>
                        <div class="select-dropdown" id="selectDropdown-datatype" role="listbox" aria-hidden="true">
                            <div class="select-option" role="option" tabindex="0" data-value="table"><span class="select-option-text">Таблица</span></div>
                            <div class="select-option" role="option" tabindex="0" data-value="xml"><span class="select-option-text">XML</span></div>
                            <div class="select-option" role="option" tabindex="0" data-value="query"><span class="select-option-text">Запрос</span></div>
                        </div>
                    </div>

                    <!-- Select: Дата (встроенный календарь в dropdown) -->
                    <div class="select-container" data-select="month">
                        <button type="button" class="select-button select-button--size-40" id="selectButton-month" aria-haspopup="listbox" aria-expanded="false" aria-controls="selectDropdown-month">
                            <span class="select-text" id="monthText">Дата</span>
                            <span class="select-icon" id="selectIcon-month">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </span>
                        </button>
                        <div class="select-dropdown" id="selectDropdown-month" role="listbox" aria-hidden="true">
                            <div class="calendar-container">
                                <div class="calendar-header">
                                    <div class="calendar-titles">
                                        <div class="calendar-title-group" id="monthTitleGroup2">
                                            <button class="calendar-title-button" id="monthTitleBtn2" aria-haspopup="listbox" aria-expanded="false" aria-controls="monthDropdown2">
                                                <span class="calendar-title-text--month" id="monthTitleText2">—</span>
                                                <span class="calendar-title-icon" id="monthChevron2"></span>
                                            </button>
                                            <div class="select-dropdown calendar-dropdown" id="monthDropdown2" role="listbox" aria-hidden="true"></div>
                                        </div>
                                        <div class="calendar-title-group" id="yearTitleGroup2" style="margin-left:auto;">
                                            <button class="calendar-title-button" id="yearTitleBtn2" aria-haspopup="listbox" aria-expanded="false" aria-controls="yearDropdown2">
                                                <span class="calendar-title-text--year" id="yearTitleText2">—</span>
                                                <span class="calendar-title-icon" id="yearChevron2"></span>
                                            </button>
                                            <div class="select-dropdown calendar-dropdown" id="yearDropdown2" role="listbox" aria-hidden="true"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="calendar-grid" id="calendarWeekdays2" aria-hidden="true"></div>
                                <div class="calendar-grid" id="calendarDays2" role="grid" aria-label="Выбор даты"></div>
                                <div id="calendarStatus2" class="sr-only" aria-live="polite"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Primary Button -->
                    <button class="btn btn--style-action btn--size-40" type="button" id="build-report-btn">Сформировать</button>
                </div>
            </section>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Применяем сохраненную тему и иконку back
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            try {
                const svg = await window.iconSystemV3.renderIconOriginal('chevron-left', 16, 'icon');
                const el = document.getElementById('backIcon-filters');
                if (el) el.innerHTML = svg;
            } catch {}
            // Инициализация всех локальных select-компонентов в этой странице
            initializeLocalSelects();
        });

        function initializeLocalSelects() {
            const containers = document.querySelectorAll('.filters-row .select-container');

            const closeAll = (except = null) => {
                containers.forEach(cn => {
                    if (cn === except) return;
                    const btn = cn.querySelector('.select-button');
                    const dd = cn.querySelector('.select-dropdown');
                    const icon = cn.querySelector('.select-icon');
                    if (dd && dd.classList.contains('select-dropdown-open')) {
                        dd.classList.remove('select-dropdown-open');
                        btn && btn.setAttribute('aria-expanded', 'false');
                        icon && icon.classList.remove('select-icon-up');
                        dd.setAttribute('aria-hidden', 'true');
                    }
                });
            };

            containers.forEach(container => {
                const button = container.querySelector('.select-button');
                const dropdown = container.querySelector('.select-dropdown');
                const icon = container.querySelector('.select-icon');
                const options = dropdown.querySelectorAll('.select-option');

                const toggle = () => {
                    const isOpen = dropdown.classList.contains('select-dropdown-open');
                    if (isOpen) {
                        dropdown.classList.remove('select-dropdown-open');
                        button.setAttribute('aria-expanded', 'false');
                        icon.classList.remove('select-icon-up');
                        dropdown.setAttribute('aria-hidden', 'true');
                    } else {
                        closeAll(container);
                        dropdown.classList.add('select-dropdown-open');
                        button.setAttribute('aria-expanded', 'true');
                        icon.classList.add('select-icon-up');
                        dropdown.setAttribute('aria-hidden', 'false');
                    }
                };

                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toggle();
                });

                options.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        // Универсально получаем текст опции: обычный (.select-option-text) или кастомный (месяц+год)
                        const textNode = option.querySelector('.select-option-text');
                        let text;
                        if (textNode) {
                            text = textNode.textContent;
                        } else {
                            const monthEl = option.querySelector('.select-option-month');
                            const yearEl = option.querySelector('.select-option-year');
                            if (monthEl && yearEl) {
                                text = `${monthEl.textContent}, ${yearEl.textContent}`;
                            } else {
                                text = option.textContent.trim();
                            }
                        }
                        button.querySelector('.select-text').textContent = text;
                        options.forEach(o => o.classList.remove('select-option-selected'));
                        option.classList.add('select-option-selected');
                        toggle();
                    });
                    option.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            option.click();
                        }
                    });
                });

                button.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (!dropdown.classList.contains('select-dropdown-open')) toggle();
                        const first = dropdown.querySelector('.select-option');
                        first && first.focus();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        if (dropdown.classList.contains('select-dropdown-open')) toggle();
                    }
                });
            });

            // Клик вне — закрыть все
            document.addEventListener('click', () => closeAll());

            // Инициализация встроенного календаря для селекта месяца (вторая версия)
            initEmbeddedCalendar();
        }

        function initEmbeddedCalendar() {
            // Месяцы и базовое состояние
            const monthNames = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
            const weekdays = ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];
            const state = { viewYear: new Date().getFullYear(), viewMonth: new Date().getMonth(), selected: null, today: new Date() };

            const monthTitleBtn = document.getElementById('monthTitleBtn2');
            const monthTitleText = document.getElementById('monthTitleText2');
            const monthDropdown = document.getElementById('monthDropdown2');
            const monthChevron = document.getElementById('monthChevron2');
            const yearTitleBtn = document.getElementById('yearTitleBtn2');
            const yearTitleText = document.getElementById('yearTitleText2');
            const yearDropdown = document.getElementById('yearDropdown2');
            const weekdaysContainer = document.getElementById('calendarWeekdays2');
            const daysContainer = document.getElementById('calendarDays2');
            const monthTextOnButton = document.getElementById('monthText');

            if (!monthTitleBtn || !daysContainer) return;

            // Рисуем chevrons
            try {
                const chevronDown = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                monthChevron.innerHTML = chevronDown;
                yearChevron2.innerHTML = chevronDown;
            } catch {}

            // Недели
            weekdaysContainer.innerHTML = '';
            weekdays.forEach(w => { const el = document.createElement('div'); el.className = 'calendar-weekday'; el.textContent = w; weekdaysContainer.appendChild(el); });

            // Dropdownы месяцев/лет
            monthDropdown.innerHTML = monthNames.map((name, idx) => (`<div class=\"select-option\" role=\"option\" data-value=\"${idx}\" tabindex=\"0\"><span class=\"select-option-text\">${name}</span></div>`)).join('');
            const baseYear = state.viewYear + 1;
            const years = Array.from({length: 11}, (_, i) => baseYear - i);
            yearDropdown.innerHTML = years.map(y => (`<div class=\"select-option\" role=\"option\" data-value=\"${y}\" tabindex=\"0\"><span class=\"select-option-text\">${y}</span></div>`)).join('');

            function setMonthYearLabel() {
                monthTitleText.textContent = monthNames[state.viewMonth];
                yearTitleText.textContent = String(state.viewYear);
            }

            function compareDates(y, m, d, dateObj) { return y === dateObj.getFullYear() && m === dateObj.getMonth() && d === dateObj.getDate(); }

            function renderDays() {
                daysContainer.innerHTML = '';
                const firstOfMonth = new Date(state.viewYear, state.viewMonth, 1);
                let startWeekDay = firstOfMonth.getDay(); if (startWeekDay === 0) startWeekDay = 7;
                const daysInPrevMonth = new Date(state.viewYear, state.viewMonth, 0).getDate();
                const daysInMonth = new Date(state.viewYear, state.viewMonth + 1, 0).getDate();
                const leading = startWeekDay - 1;
                const totalCells = Math.ceil((leading + daysInMonth) / 7) * 7;
                for (let cell = 0; cell < totalCells; cell++) {
                    const dayNum = cell - leading + 1;
                    const isPrev = cell < leading;
                    const isNext = cell >= (leading + daysInMonth);
                    let y = state.viewYear; let m = state.viewMonth; let d;
                    if (isPrev) { m = (m + 11) % 12; y = state.viewMonth === 0 ? y - 1 : y; d = daysInPrevMonth - (leading - cell - 1); }
                    else if (isNext) { m = (m + 1) % 12; y = state.viewMonth === 11 ? y + 1 : y; d = (cell - (leading + daysInMonth)) + 1; }
                    else { d = dayNum; }
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn--size-32 btn--style-blank btn--icon-only calendar-day-btn';
                    btn.textContent = String(d);
                    btn.dataset.y = String(y); btn.dataset.m = String(m); btn.dataset.d = String(d);
                    if (isPrev || isNext) btn.classList.add('is-other-month');
                    if (compareDates(y, m, d, state.today)) { btn.classList.remove('btn--style-blank'); btn.classList.add('btn--style-action', 'is-today'); }
                    if (state.selected && y === state.selected.y && m === state.selected.m && d === state.selected.d) { btn.classList.remove('btn--style-blank'); btn.classList.add('btn--style-outline'); }
                    btn.addEventListener('click', () => {
                        state.viewYear = y; state.viewMonth = m; state.selected = { y, m, d };
                        setMonthYearLabel(); renderDays();
                        // Проставляем выбранную дату в текст кнопки селекта и закрываем dropdown
                        const monthLabel = monthNames[m];
                        monthTextOnButton.textContent = `${String(d).padStart(2,'0')} ${monthLabel} ${y}`;
                        const monthSelectContainer = document.querySelector('[data-select="month"]');
                        if (monthSelectContainer) {
                            const dd = monthSelectContainer.querySelector('#selectDropdown-month');
                            const btn = monthSelectContainer.querySelector('#selectButton-month');
                            const icon = monthSelectContainer.querySelector('#selectIcon-month');
                            if (dd) dd.classList.remove('select-dropdown-open');
                            if (btn) btn.setAttribute('aria-expanded','false');
                            if (icon) icon.classList.remove('select-icon-up');
                            if (dd) dd.setAttribute('aria-hidden','true');
                        }
                    });
                    daysContainer.appendChild(btn);
                }
            }

            function toggleDD(btn, dd, chev) { const exp = btn.getAttribute('aria-expanded') === 'true'; if (exp) { btn.setAttribute('aria-expanded','false'); dd.setAttribute('aria-hidden','true'); dd.classList.remove('select-dropdown-open'); chev && chev.classList.remove('select-icon-up'); } else { btn.setAttribute('aria-expanded','true'); dd.setAttribute('aria-hidden','false'); dd.classList.add('select-dropdown-open'); chev && chev.classList.add('select-icon-up'); } }

            monthTitleBtn.addEventListener('click', () => toggleDD(monthTitleBtn, monthDropdown, monthChevron));
            yearTitleBtn.addEventListener('click', () => toggleDD(yearTitleBtn, yearDropdown, yearChevron2));
            monthDropdown.addEventListener('click', (e) => { const opt = e.target.closest('.select-option'); if (!opt) return; state.viewMonth = Number(opt.dataset.value); setMonthYearLabel(); renderDays(); toggleDD(monthTitleBtn, monthDropdown, monthChevron); });
            yearDropdown.addEventListener('click', (e) => { const opt = e.target.closest('.select-option'); if (!opt) return; state.viewYear = Number(opt.dataset.value); setMonthYearLabel(); renderDays(); toggleDD(yearTitleBtn, yearDropdown, yearChevron2); });

            document.addEventListener('click', (e) => {
                const g1 = document.getElementById('monthTitleGroup2'); const g2 = document.getElementById('yearTitleGroup2');
                if (g1 && !g1.contains(e.target)) toggleForceClose(monthTitleBtn, monthDropdown, monthChevron);
                if (g2 && !g2.contains(e.target)) toggleForceClose(yearTitleBtn, yearDropdown, yearChevron2);
            });

            function toggleForceClose(btn, dd, chev) { if (btn && dd && dd.classList.contains('select-dropdown-open')) { btn.setAttribute('aria-expanded','false'); dd.setAttribute('aria-hidden','true'); dd.classList.remove('select-dropdown-open'); chev && chev.classList.remove('select-icon-up'); } }

            setMonthYearLabel(); renderDays();
        }
    </script>
</body>
</html>


